# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This repository contains the TypeScript/Node.js SDK for Schematic, a feature flag and user segmentation service. The SDK provides a client for interacting with the Schematic API, enabling applications to identify users/companies, track events, check feature flags, and more.

## Build and Development Commands

```bash
# Install dependencies
yarn install

# Build the project
yarn build

# Format code
yarn format

# Run tests
yarn test

# Run a specific test file
npx jest path/to/test/file.test.ts

# Run tests with coverage
npx jest --coverage

# Build the package for distribution 
yarn build
```

## Architecture Overview

### Client Structure

The SDK is organized around a core client architecture:

1. **Base Client (Client.ts)**: Generated by Fern, provides basic API interfaces for all Schematic resources.

2. **Wrapped Client (wrapper.ts)**: Extends the base client with additional functionality:
   - Local caching for flag checks
   - Event buffering and batching
   - Offline mode for testing
   - Error handling and logging

3. **Resource Clients**: Organized by functional area (features, companies, events, etc.) with each providing specific API operations.

### Key Components

1. **API Resources**: Located in `/src/api/resources/`, each subdirectory represents a different API resource area like features, companies, accounts, etc.

2. **EventBuffer**: Manages a queue of events, batching them together and sending them periodically to reduce API load.

3. **LocalCache**: Provides in-memory caching for feature flag checks with LRU eviction.

4. **Webhook Verification**: Utilities for verifying webhook signatures from Schematic.

### Data Flow

1. Client initialization with API key and optional configuration
2. For feature flag checks:
   - Check local cache first
   - If not found, make API request
   - Cache the result
   - Return value or fallback to default
3. For event tracking:
   - Events are added to buffer
   - Buffer flushes periodically or when full
   - Failed requests are logged but do not throw errors to the caller

## Best Practices

1. **Client Lifecycle**: Always call `client.close()` when finished with the client to flush remaining events.

2. **Error Handling**: The SDK handles most errors internally, logging errors but not throwing them for operations like tracking events. Developers can override the default logger.

3. **Caching**: Understanding the caching mechanism is important for performance. Default cache TTL is 5 seconds with 1000 items max.

4. **Webhook Verification**: When implementing webhooks, always use the signature verification utilities to ensure webhook authenticity.

5. **Testing**: Use offline mode (`new SchematicClient({ offline: true })`) with flag defaults for testing.